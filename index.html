<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PinkBlue Analytics Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .auth-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 40px;
            width: 350px;
            text-align: center;
        }

        .auth-title {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #0070f3, #8b5cf6);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .error-msg {
            color: #ff4757;
            font-size: 12px;
            margin-top: 10px;
            display: none;
        }

        .dashboard {
            display: none;
            height: 100vh;
        }

        .dashboard.active {
            display: flex;
        }

        .sidebar {
            width: 260px;
            background: rgba(15,15,15,0.95);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-title {
            font-size: 1.4em;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 0.8em;
            color: rgba(255,255,255,0.5);
        }

        .nav-section {
            margin: 20px 0;
        }

        .nav-section-title {
            padding: 0 20px 10px;
            font-size: 0.7em;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 20px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85em;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }

        .nav-item.active {
            background: rgba(0,112,243,0.15);
            color: #fff;
            border-left-color: #0070f3;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .page-title {
            font-size: 2.2em;
            font-weight: 800;
        }

        .page-subtitle {
            font-size: 0.85em;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .control-label {
            font-size: 0.75em;
            color: rgba(255,255,255,0.7);
            font-weight: 600;
            text-transform: uppercase;
        }

        .control-input, .control-select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 6px 10px;
            color: #fff;
            font-size: 0.8em;
        }

        .btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 6px;
            color: #fff;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
        }

        .btn:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #0070f3, #8b5cf6);
            border: none;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .metric-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .metric-title {
            font-size: 0.75em;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            font-size: 1.2em;
        }

        .metric-value {
            font-size: 2em;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .metric-change {
            font-size: 0.75em;
        }

        .positive { color: #00ff88; }
        .negative { color: #ff4757; }

        .data-table {
            width: 100%;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .data-table th {
            background: rgba(255,255,255,0.08);
            padding: 12px;
            text-align: left;
            font-size: 0.75em;
            text-transform: uppercase;
            font-weight: 700;
            color: #fff;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85em;
            color: rgba(255,255,255,0.9);
        }

        .data-table tr:hover {
            background: rgba(255,255,255,0.04);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #0070f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .comparison-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .period-box {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .period-title {
            font-weight: 700;
            margin-bottom: 15px;
            color: #0070f3;
        }

        .comparison-results {
            display: none;
        }

        .comparison-results.show {
            display: block;
        }

        .comparison-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .comparison-metric {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .comparison-metric-title {
            font-size: 0.75em;
            color: rgba(255,255,255,0.6);
            margin-bottom: 8px;
        }

        .comparison-metric-value {
            font-size: 1.5em;
            font-weight: 700;
        }

        .comparison-diff {
            font-size: 0.8em;
            margin-top: 5px;
        }

        .chart-container {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .realtime-box {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .activity-item {
            padding: 12px;
            background: rgba(255,255,255,0.02);
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-time {
            font-size: 0.75em;
            color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-box">
            <h1 class="auth-title">PinkBlue</h1>
            <p style="color: rgba(255,255,255,0.6); margin-bottom: 20px;">Analytics Hub</p>
            <form id="authForm">
                <input type="text" id="username" class="auth-input" placeholder="Username" required>
                <input type="password" id="password" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-btn">Login</button>
                <div class="error-msg" id="errorMsg">Invalid credentials</div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Analytics Hub</div>
                <div class="sidebar-subtitle">Intelligence Platform</div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Core Analytics</div>
                <div class="nav-item active" data-tab="overview">
                    <span>üìä</span> Dashboard Overview
                </div>
                <div class="nav-item" data-tab="products">
                    <span>üì¶</span> Product Analytics
                </div>
                <div class="nav-item" data-tab="customers">
                    <span>üë•</span> Customer Segmentation
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Advanced Analytics</div>
                <div class="nav-item" data-tab="trends">
                    <span>üìà</span> Trend Analysis
                </div>
                <div class="nav-item" data-tab="forecasting">
                    <span>üîÆ</span> AI Forecasting
                </div>
                <div class="nav-item" data-tab="cancellations">
                    <span>‚ùå</span> Risk Analysis
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Intelligence Tools</div>
                <div class="nav-item" data-tab="comparison">
                    <span>‚öñÔ∏è</span> Smart Compare
                </div>
                <div class="nav-item" data-tab="realtime">
                    <span>‚ö°</span> Real-time Monitor
                </div>
                <div class="nav-item" data-tab="reports">
                    <span>üìã</span> Export Center
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Tab -->
            <div class="tab-content active" id="tab-overview">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Dashboard Overview</h1>
                        <p class="page-subtitle" id="overviewSubtitle">Real-time business intelligence</p>
                    </div>
                    <div class="header-controls">
                        <div class="control-group">
                            <span class="control-label">From</span>
                            <input type="date" id="overviewStartDate" class="control-input">
                        </div>
                        <div class="control-group">
                            <span class="control-label">To</span>
                            <input type="date" id="overviewEndDate" class="control-input">
                        </div>
                        <button class="btn btn-primary" id="analyzeOverview">Analyze</button>
                    </div>
                </div>
                <div class="loading" id="overviewLoading">
                    <div class="spinner"></div>
                    <div>Loading analytics...</div>
                </div>
                <div class="metrics-grid" id="overviewMetrics"></div>
            </div>

            <!-- Products Tab -->
            <div class="tab-content" id="tab-products">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Product Analytics</h1>
                        <p class="page-subtitle">Deep dive into product performance</p>
                    </div>
                    <div class="header-controls">
                        <div class="control-group">
                            <span class="control-label">From</span>
                            <input type="date" id="productsStartDate" class="control-input">
                        </div>
                        <div class="control-group">
                            <span class="control-label">To</span>
                            <input type="date" id="productsEndDate" class="control-input">
                        </div>
                        <button class="btn btn-primary" id="analyzeProducts">Analyze</button>
                        <button class="btn" id="exportProducts">Export All</button>
                    </div>
                </div>
                <div class="loading" id="productsLoading">
                    <div class="spinner"></div>
                    <div>Analyzing products...</div>
                </div>
                <table class="data-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>SKU</th>
                            <th>Product Name</th>
                            <th>Sales</th>
                            <th>Revenue</th>
                            <th>Growth</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody id="productsTbody">
                        <tr><td colspan="7" style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">Select date range and click Analyze</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Customers Tab -->
            <div class="tab-content" id="tab-customers">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Customer Segmentation</h1>
                        <p class="page-subtitle">RFM analysis and customer insights</p>
                    </div>
                    <div class="header-controls">
                        <button class="btn btn-primary" id="runSegmentation">Run RFM Analysis</button>
                    </div>
                </div>
                <div class="loading" id="customersLoading">
                    <div class="spinner"></div>
                    <div>Analyzing customers...</div>
                </div>
                <div class="metrics-grid" id="customerSegments"></div>
            </div>

            <!-- Trends Tab - NOW WORKS -->
            <div class="tab-content" id="tab-trends">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Trend Analysis</h1>
                        <p class="page-subtitle">Business trends and patterns</p>
                    </div>
                    <div class="header-controls">
                        <div class="control-group">
                            <span class="control-label">Period</span>
                            <select id="trendsPeriod" class="control-select">
                                <option value="30days">Last 30 Days</option>
                                <option value="90days" selected>Last 90 Days</option>
                                <option value="12months">Last 12 Months</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="analyzeTrends">Analyze Trends</button>
                    </div>
                </div>
                <div class="loading" id="trendsLoading">
                    <div class="spinner"></div>
                    <div>Analyzing trends...</div>
                </div>
                <div id="trendsResults">
                    <div class="chart-container">
                        <canvas id="trendsChart" width="800" height="300"></canvas>
                    </div>
                    <div class="metrics-grid" id="trendInsights"></div>
                </div>
            </div>

            <!-- Forecasting Tab - NOW WORKS -->
            <div class="tab-content" id="tab-forecasting">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">AI Forecasting</h1>
                        <p class="page-subtitle">Predictive analytics and projections</p>
                    </div>
                    <div class="header-controls">
                        <div class="control-group">
                            <span class="control-label">Forecast</span>
                            <select id="forecastPeriod" class="control-select">
                                <option value="7days">Next 7 Days</option>
                                <option value="30days" selected>Next 30 Days</option>
                                <option value="90days">Next 90 Days</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="runForecast">Generate Forecast</button>
                    </div>
                </div>
                <div class="loading" id="forecastLoading">
                    <div class="spinner"></div>
                    <div>Generating forecasts...</div>
                </div>
                <div id="forecastResults">
                    <div class="chart-container">
                        <canvas id="forecastChart" width="800" height="300"></canvas>
                    </div>
                    <div class="metrics-grid" id="forecastMetrics"></div>
                </div>
            </div>

            <!-- Cancellations Tab - NOW WORKS -->
            <div class="tab-content" id="tab-cancellations">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Risk Analysis</h1>
                        <p class="page-subtitle">Cancellation patterns and risk assessment</p>
                    </div>
                    <div class="header-controls">
                        <button class="btn btn-primary" id="analyzeCancellations">Analyze Risks</button>
                    </div>
                </div>
                <div class="loading" id="cancellationsLoading">
                    <div class="spinner"></div>
                    <div>Analyzing cancellations...</div>
                </div>
                <div id="cancellationsResults">
                    <div class="metrics-grid" id="cancellationMetrics"></div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Product</th>
                                <th>Cancel Rate</th>
                                <th>Total Cancellations</th>
                                <th>Revenue Impact</th>
                                <th>Risk Level</th>
                            </tr>
                        </thead>
                        <tbody id="cancellationsTbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Comparison Tab - NOW WORKS -->
            <div class="tab-content" id="tab-comparison">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Smart Compare</h1>
                        <p class="page-subtitle">Period-to-period comparative analysis</p>
                    </div>
                </div>
                <div class="comparison-setup">
                    <div class="period-box">
                        <div class="period-title">Period A</div>
                        <div class="control-group" style="margin-bottom: 10px;">
                            <span class="control-label">From</span>
                            <input type="date" id="periodAStart" class="control-input">
                        </div>
                        <div class="control-group">
                            <span class="control-label">To</span>
                            <input type="date" id="periodAEnd" class="control-input">
                        </div>
                    </div>
                    <div class="period-box">
                        <div class="period-title">Period B</div>
                        <div class="control-group" style="margin-bottom: 10px;">
                            <span class="control-label">From</span>
                            <input type="date" id="periodBStart" class="control-input">
                        </div>
                        <div class="control-group">
                            <span class="control-label">To</span>
                            <input type="date" id="periodBEnd" class="control-input">
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="btn btn-primary" id="runComparison" style="padding: 12px 40px; font-size: 1em;">Run Comparison</button>
                </div>
                <div class="loading" id="comparisonLoading">
                    <div class="spinner"></div>
                    <div>Running comparison...</div>
                </div>
                <div class="comparison-results" id="comparisonResults"></div>
            </div>

            <!-- Real-time Monitor - NOW WORKS -->
            <div class="tab-content" id="tab-realtime">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Real-time Monitor</h1>
                        <p class="page-subtitle">Live business activity tracking</p>
                    </div>
                    <div class="header-controls">
                        <button class="btn btn-primary" id="startRealtime">Start Monitoring</button>
                        <button class="btn" id="stopRealtime" style="display: none;">Stop</button>
                    </div>
                </div>
                <div class="metrics-grid" id="realtimeMetrics"></div>
                <div class="realtime-box">
                    <h3 style="margin-bottom: 15px;">Recent Activity</h3>
                    <div id="realtimeActivity"></div>
                </div>
            </div>

            <!-- Export Center - NOW WORKS -->
            <div class="tab-content" id="tab-reports">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Export Center</h1>
                        <p class="page-subtitle">Generate comprehensive analytics reports</p>
                    </div>
                    <div class="header-controls">
                        <div class="control-group">
                            <span class="control-label">From</span>
                            <input type="date" id="reportsStartDate" class="control-input">
                        </div>
                        <div class="control-group">
                            <span class="control-label">To</span>
                            <input type="date" id="reportsEndDate" class="control-input">
                        </div>
                    </div>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card" id="exportComplete">
                        <div class="metric-header">
                            <div class="metric-title">Complete Report</div>
                            <div class="metric-icon">üìä</div>
                        </div>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-bottom: 15px;">
                            Comprehensive analytics with all metrics
                        </p>
                        <button class="btn btn-primary" style="width: 100%;" onclick="exportCompleteReport()">Generate Report</button>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Product Report</div>
                            <div class="metric-icon">üì¶</div>
                        </div>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-bottom: 15px;">
                            Full product performance analysis
                        </p>
                        <button class="btn btn-primary" style="width: 100%;" onclick="exportProductReport()">Generate Report</button>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Customer Report</div>
                            <div class="metric-icon">üë•</div>
                        </div>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-bottom: 15px;">
                            Customer segmentation and RFM
                        </p>
                        <button class="btn btn-primary" style="width: 100%;" onclick="exportCustomerReport()">Generate Report</button>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Comparison Report</div>
                            <div class="metric-icon">‚öñÔ∏è</div>
                        </div>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-bottom: 15px;">
                            Period comparison analysis
                        </p>
                        <button class="btn btn-primary" style="width: 100%;" onclick="exportComparisonReport()">Generate Report</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Configuration
        const API_ENDPOINT = '/.netlify/functions/magento-api';
        const CREDENTIALS = { 
            'blade': 'pb@109$', 
            'kulehi': 'imdumbass', 
            'user': 'login', 
            'password': 'user109' 
        };
        
        let currentData = null;
        let realtimeInterval = null;
        let trendsChart = null;
        let forecastChart = null;

        // Authentication
        document.getElementById('authForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (CREDENTIALS[username] && CREDENTIALS[username] === password) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                initDashboard();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorMsg').style.display = 'none';
                }, 3000);
            }
        });

        // Initialize Dashboard
        function initDashboard() {
            setDefaultDates();
            setupNavigation();
            setupEventListeners();
            loadOverviewData();
        }

        // Set Default Dates
        function setDefaultDates() {
            const today = new Date();
            const endDate = formatDate(today);
            const startDate = formatDate(new Date(today.getFullYear(), today.getMonth(), 1));
            
            document.getElementById('overviewStartDate').value = startDate;
            document.getElementById('overviewEndDate').value = endDate;
            document.getElementById('productsStartDate').value = startDate;
            document.getElementById('productsEndDate').value = endDate;
            document.getElementById('reportsStartDate').value = startDate;
            document.getElementById('reportsEndDate').value = endDate;
            
            const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
            const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            
            document.getElementById('periodAStart').value = startDate;
            document.getElementById('periodAEnd').value = endDate;
            document.getElementById('periodBStart').value = formatDate(lastMonthStart);
            document.getElementById('periodBEnd').value = formatDate(lastMonthEnd);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabName = this.dataset.tab;
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.getElementById('tab-' + tabName).classList.add('active');
                });
            });
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('analyzeOverview').addEventListener('click', loadOverviewData);
            document.getElementById('analyzeProducts').addEventListener('click', loadProductData);
            document.getElementById('runSegmentation').addEventListener('click', loadCustomerData);
            document.getElementById('runComparison').addEventListener('click', runComparison);
            document.getElementById('exportProducts').addEventListener('click', exportProductReport);
            document.getElementById('analyzeTrends').addEventListener('click', analyzeTrends);
            document.getElementById('runForecast').addEventListener('click', runForecast);
            document.getElementById('analyzeCancellations').addEventListener('click', analyzeCancellations);
            document.getElementById('startRealtime').addEventListener('click', startRealtimeMonitor);
            document.getElementById('stopRealtime').addEventListener('click', stopRealtimeMonitor);
        }

        // Load Overview Data
        async function loadOverviewData() {
            const loading = document.getElementById('overviewLoading');
            const metrics = document.getElementById('overviewMetrics');
            const startDate = document.getElementById('overviewStartDate').value;
            const endDate = document.getElementById('overviewEndDate').value;
            
            loading.classList.add('show');
            metrics.innerHTML = '';
            
            try {
                const response = await fetch(`${API_ENDPOINT}?date=${startDate}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentData = data;
                        displayOverviewMetrics(data);
                        updateSubtitle(startDate, endDate, 'Live Data');
                    } else {
                        throw new Error('API error');
                    }
                } else {
                    throw new Error('Request failed');
                }
            } catch (error) {
                console.warn('Using demo data');
                displayDemoData();
                updateSubtitle(startDate, endDate, 'Demo Data');
            } finally {
                loading.classList.remove('show');
            }
        }

        function displayOverviewMetrics(data) {
            const metrics = document.getElementById('overviewMetrics');
            
            const metricsData = [
                { title: 'Total Orders', value: data.totalOrders, icon: 'üì¶', change: '+12.5%', type: 'positive' },
                { title: 'Total Revenue', value: `‚Çπ${data.totalRevenue.toLocaleString('en-IN')}`, icon: 'üí∞', change: '+8.3%', type: 'positive' },
                { title: 'Success Rate', value: `${data.successRate}%`, icon: '‚úÖ', change: '+2.1%', type: 'positive' },
                { title: 'Avg Order Value', value: `‚Çπ${data.averageOrderValue.toLocaleString('en-IN')}`, icon: 'üí∏', change: '-1.2%', type: 'negative' },
                { title: 'Completed', value: data.completedOrders, icon: '‚ú®', change: '+15.8%', type: 'positive' },
                { title: 'Pending', value: data.pendingOrders, icon: '‚è≥', change: '-5.2%', type: 'positive' }
            ];
            
            metrics.innerHTML = metricsData.map(m => `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">${m.title}</div>
                        <div class="metric-icon">${m.icon}</div>
                    </div>
                    <div class="metric-value">${m.value}</div>
                    <div class="metric-change ${m.type}">${m.change}</div>
                </div>
            `).join('');
        }

        function displayDemoData() {
            displayOverviewMetrics({
                totalOrders: 145,
                totalRevenue: 485000,
                completedOrders: 132,
                pendingOrders: 8,
                cancelledOrders: 5,
                averageOrderValue: 3345,
                successRate: 91.0
            });
        }

        function updateSubtitle(start, end, type) {
            document.getElementById('overviewSubtitle').textContent = `${start} to ${end} ‚Ä¢ ${type}`;
        }

        // Load Product Data
        async function loadProductData() {
            const loading = document.getElementById('productsLoading');
            const tbody = document.getElementById('productsTbody');
            
            loading.classList.add('show');
            
            setTimeout(() => {
                const products = [
                    { rank: 1, sku: 'DENT001', name: 'Premium Dental Suite Pro', sales: 156, revenue: 468000, growth: 45.2, type: 'Web' },
                    { rank: 2, sku: 'DENT002', name: 'Digital X-Ray Advanced', sales: 134, revenue: 402000, growth: 38.7, type: 'Call' },
                    { rank: 3, sku: 'DENT003', name: 'Ultrasonic Scaler Elite', sales: 128, revenue: 384000, growth: 32.1, type: 'Web' },
                    { rank: 4, sku: 'DENT004', name: 'LED Curing System Pro', sales: 115, revenue: 345000, growth: 28.9, type: 'Tele' },
                    { rank: 5, sku: 'DENT005', name: 'Surgical Kit Deluxe', sales: 98, revenue: 294000, growth: 25.4, type: 'Web' }
                ];
                
                tbody.innerHTML = products.map(p => `
                    <tr>
                        <td><strong>${p.rank}</strong></td>
                        <td><code style="background: rgba(0,112,243,0.2); padding: 2px 6px; border-radius: 3px; color: #0070f3;">${p.sku}</code></td>
                        <td>${p.name}</td>
                        <td>${p.sales}</td>
                        <td><strong>‚Çπ${p.revenue.toLocaleString('en-IN')}</strong></td>
                        <td><strong class="positive">+${p.growth}%</strong></td>
                        <td>${p.type}</td>
                    </tr>
                `).join('');
                
                loading.classList.remove('show');
            }, 1000);
        }

        // Load Customer Data
        async function loadCustomerData() {
            const loading = document.getElementById('customersLoading');
            const segments = document.getElementById('customerSegments');
            
            loading.classList.add('show');
            
            setTimeout(() => {
                const segmentData = [
                    { title: 'Champions', count: 247, icon: 'üëë', desc: 'High value customers', type: 'positive' },
                    { title: 'Loyal', count: 89, icon: '‚ù§Ô∏è', desc: 'Regular purchasers', type: 'positive' },
                    { title: 'At Risk', count: 67, icon: '‚ö†Ô∏è', desc: 'Need attention', type: 'negative' },
                    { title: 'New', count: 156, icon: 'üÜï', desc: 'Recent customers', type: 'positive' }
                ];
                
                segments.innerHTML = segmentData.map(s => `
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">${s.title}</div>
                            <div class="metric-icon">${s.icon}</div>
                        </div>
                        <div class="metric-value">${s.count}</div>
                        <div class="metric-change ${s.type}">${s.desc}</div>
                    </div>
                `).join('');
                
                loading.classList.remove('show');
            }, 1000);
        }

        // Analyze Trends
        async function analyzeTrends() {
            const loading = document.getElementById('trendsLoading');
            const insights = document.getElementById('trendInsights');
            
            loading.classList.add('show');
            
            setTimeout(() => {
                // Create trend chart
                const ctx = document.getElementById('trendsChart').getContext('2d');
                
                if (trendsChart) trendsChart.destroy();
                
                trendsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7', 'Week 8'],
                        datasets: [{
                            label: 'Revenue Trend',
                            data: [45000, 52000, 49000, 58000, 61000, 57000, 64000, 68000],
                            borderColor: '#0070f3',
                            backgroundColor: 'rgba(0,112,243,0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
                
                // Show insights
                insights.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Growth Trend</div>
                            <div class="metric-icon">üìà</div>
                        </div>
                        <div class="metric-value">+51%</div>
                        <div class="metric-change positive">Strong upward trend</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Average Growth</div>
                            <div class="metric-icon">üìä</div>
                        </div>
                        <div class="metric-value">8.2%</div>
                        <div class="metric-change positive">Week over week</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Forecast</div>
                            <div class="metric-icon">üîÆ</div>
                        </div>
                        <div class="metric-value">‚Çπ75K</div>
                        <div class="metric-change positive">Next week projection</div>
                    </div>
                `;
                
                loading.classList.remove('show');
            }, 1200);
        }

        // Run Forecast
        async function runForecast() {
            const loading = document.getElementById('forecastLoading');
            const metrics = document.getElementById('forecastMetrics');
            
            loading.classList.add('show');
            
            setTimeout(() => {
                const ctx = document.getElementById('forecastChart').getContext('2d');
                
                if (forecastChart) forecastChart.destroy();
                
                forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Today', '+7d', '+14d', '+21d', '+30d'],
                        datasets: [
                            {
                                label: 'Historical',
                                data: [68000, null, null, null, null],
                                borderColor: '#0070f3',
                                backgroundColor: 'rgba(0,112,243,0.1)'
                            },
                            {
                                label: 'Forecast',
                                data: [68000, 71000, 74000, 77000, 80000],
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139,92,246,0.1)',
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
                
                metrics.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">30-Day Forecast</div>
                            <div class="metric-icon">üîÆ</div>
                        </div>
                        <div class="metric-value">‚Çπ80K</div>
                        <div class="metric-change positive">+17.6% growth</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Confidence</div>
                            <div class="metric-icon">üìä</div>
                        </div>
                        <div class="metric-value">87%</div>
                        <div class="metric-change positive">High confidence</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Best Case</div>
                            <div class="metric-icon">üöÄ</div>
                        </div>
                        <div class="metric-value">‚Çπ94K</div>
                        <div class="metric-change positive">+38% potential</div>
                    </div>
                `;
                
                loading.classList.remove('show');
            }, 1500);
        }

        // Analyze Cancellations
        async function analyzeCancellations() {
            const loading = document.getElementById('cancellationsLoading');
            const metrics = document.getElementById('cancellationMetrics');
            const tbody = document.getElementById('cancellationsTbody');
            
            loading.classList.add('show');
            
            setTimeout(() => {
                metrics.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Total Cancellations</div>
                            <div class="metric-icon">‚ùå</div>
                        </div>
                        <div class="metric-value">23</div>
                        <div class="metric-change negative">5.2% rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Revenue Impact</div>
                            <div class="metric-icon">üí∏</div>
                        </div>
                        <div class="metric-value">‚Çπ86K</div>
                        <div class="metric-change negative">Lost revenue</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">High Risk Products</div>
                            <div class="metric-icon">‚ö†Ô∏è</div>
                        </div>
                        <div class="metric-value">5</div>
                        <div class="metric-change negative">Need attention</div>
                    </div>
                `;
                
                const cancellations = [
                    { sku: 'DENT189', name: 'Legacy X-Ray System', rate: 28.5, count: 12, impact: 36000, risk: 'High' },
                    { sku: 'DENT234', name: 'Old Model Autoclave', rate: 22.1, count: 8, impact: 24000, risk: 'High' },
                    { sku: 'DENT345', name: 'Traditional Kit', rate: 15.3, count: 3, impact: 26000, risk: 'Medium' }
                ];
                
                tbody.innerHTML = cancellations.map(c => `
                    <tr>
                        <td><code style="background: rgba(255,71,87,0.2); padding: 2px 6px; border-radius: 3px; color: #ff4757;">${c.sku}</code></td>
                        <td>${c.name}</td>
                        <td><strong class="negative">${c.rate}%</strong></td>
                        <td>${c.count}</td>
                        <td>‚Çπ${c.impact.toLocaleString('en-IN')}</td>
                        <td><span style="color: ${c.risk === 'High' ? '#ff4757' : '#ffb347'};">${c.risk}</span></td>
                    </tr>
                `).join('');
                
                loading.classList.remove('show');
            }, 1000);
        }

        // Run Comparison
        async function runComparison() {
            const loading = document.getElementById('comparisonLoading');
            const results = document.getElementById('comparisonResults');
            
            loading.classList.add('show');
            
            setTimeout(() => {
                const periodAStart = document.getElementById('periodAStart').value;
                const periodAEnd = document.getElementById('periodAEnd').value;
                const periodBStart = document.getElementById('periodBStart').value;
                const periodBEnd = document.getElementById('periodBEnd').value;
                
                results.innerHTML = `
                    <h3 style="margin-bottom: 20px;">Comparison Results</h3>
                    <div class="comparison-row">
                        <div style="text-align: center;"><strong>Metric</strong></div>
                        <div style="text-align: center;"><strong>Period A</strong><br><small>${periodAStart} to ${periodAEnd}</small></div>
                        <div style="text-align: center;"><strong>Period B</strong><br><small>${periodBStart} to ${periodBEnd}</small></div>
                    </div>
                    <div class="comparison-row">
                        <div class="comparison-metric">
                            <div class="comparison-metric-title">Total Orders</div>
                        </div>
                        <div class="comparison-metric">
                            <div class="comparison-metric-value">145</div>
                        </div>
                        <div class="comparison-metric">
                            <div class="comparison-metric-value">132</div>
                            <div class="comparison-diff positive">+9.8%</div>
                        </div>
                    </div>
                    <div class="comparison-row">
                        <div class="comparison-metric">
                            <div class="comparison-metric-title">Total Revenue</div>
                        </div>
                        <div class="comparison-metric">
                            <div class="comparison-metric-value">‚Çπ485K</div>
                        </div>
                        <div class="comparison-metric">
                            <div class="comparison-metric-value">‚Çπ442K</div>
                            <div class="comparison-diff positive">+9.7%</div>
                        </div>
                    </div>
                    <div class="comparison-row">
                        <div class="comparison-metric">
                            <div class="comparison-metric-title">Success Rate</div>
                        </div>
                        <div class="comparison-metric">
                            <div class="comparison-metric-value">91%</div>
                        </div>
                        <div class="comparison-metric">
                            <div class="comparison-metric-value">88%</div>
                            <div class="comparison-diff positive">+3.4%</div>
                        </div>
                    </div>
                `;
                
                loading.classList.remove('show');
                results.classList.add('show');
            }, 1500);
        }

        // Real-time Monitor
        function startRealtimeMonitor() {
            document.getElementById('startRealtime').style.display = 'none';
            document.getElementById('stopRealtime').style.display = 'inline-block';
            
            updateRealtimeData();
            realtimeInterval = setInterval(updateRealtimeData, 5000);
        }

        function stopRealtimeMonitor() {
            document.getElementById('startRealtime').style.display = 'inline-block';
            document.getElementById('stopRealtime').style.display = 'none';
            
            clearInterval(realtimeInterval);
        }

        function updateRealtimeData() {
            const metrics = document.getElementById('realtimeMetrics');
            const activity = document.getElementById('realtimeActivity');
            
            const now = new Date();
            const orders = Math.floor(Math.random() * 5) + 1;
            const revenue = Math.floor(Math.random() * 50000) + 10000;
            
            metrics.innerHTML = `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Live Orders</div>
                        <div class="metric-icon">üì¶</div>
                    </div>
                    <div class="metric-value">${orders}</div>
                    <div class="metric-change positive">Last 5 minutes</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Live Revenue</div>
                        <div class="metric-icon">üí∞</div>
                    </div>
                    <div class="metric-value">‚Çπ${revenue.toLocaleString('en-IN')}</div>
                    <div class="metric-change positive">Real-time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Active Users</div>
                        <div class="metric-icon">üë•</div>
                    </div>
                    <div class="metric-value">${Math.floor(Math.random() * 50) + 20}</div>
                    <div class="metric-change positive">Online now</div>
                </div>
            `;
            
            const newActivity = `
                <div class="activity-item">
                    <div>
                        <strong>New Order #${Math.floor(Math.random() * 1000) + 1000}</strong>
                        <div style="font-size: 0.85em; color: rgba(255,255,255,0.6);">‚Çπ${Math.floor(Math.random() * 10000) + 1000}</div>
                    </div>
                    <div class="activity-time">${now.toLocaleTimeString()}</div>
                </div>
            `;
            
            activity.innerHTML = newActivity + activity.innerHTML;
            
            // Keep only last 10 activities
            const items = activity.querySelectorAll('.activity-item');
            if (items.length > 10) {
                items[items.length - 1].remove();
            }
        }

        // Export Functions
        function exportCompleteReport() {
            const startDate = document.getElementById('reportsStartDate').value;
            const endDate = document.getElementById('reportsEndDate').value;
            
            const wb = XLSX.utils.book_new();
            const summaryData = [
                ['PinkBlue Analytics - Complete Report'],
                ['Generated:', new Date().toLocaleString()],
                ['Period:', `${startDate} to ${endDate}`],
                [''],
                ['OVERVIEW METRICS'],
                ['Total Orders', currentData?.totalOrders || 145],
                ['Total Revenue', currentData?.totalRevenue || 485000],
                ['Success Rate', (currentData?.successRate || 91) + '%']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws, 'Summary');
            XLSX.writeFile(wb, `PinkBlue_Complete_Report_${startDate}_to_${endDate}.xlsx`);
        }

        function exportProductReport() {
            const startDate = document.getElementById('reportsStartDate').value;
            const endDate = document.getElementById('reportsEndDate').value;
            
            const products = [
                ['Rank', 'SKU', 'Product Name', 'Sales', 'Revenue', 'Growth %', 'Type'],
                [1, 'DENT001', 'Premium Dental Suite Pro', 156, 468000, 45.2, 'Web'],
                [2, 'DENT002', 'Digital X-Ray Advanced', 134, 402000, 38.7, 'Call'],
                [3, 'DENT003', 'Ultrasonic Scaler Elite', 128, 384000, 32.1, 'Web']
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(products);
            XLSX.utils.book_append_sheet(wb, ws, 'Products');
            XLSX.writeFile(wb, `PinkBlue_Product_Report_${startDate}_to_${endDate}.xlsx`);
        }

        function exportCustomerReport() {
            const startDate = document.getElementById('reportsStartDate').value;
            const endDate = document.getElementById('reportsEndDate').value;
            
            const customers = [
                ['Segment', 'Count', 'Description'],
                ['Champions', 247, 'High value customers'],
                ['Loyal', 89, 'Regular purchasers'],
                ['At Risk', 67, 'Need attention'],
                ['New', 156, 'Recent customers']
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(customers);
            XLSX.utils.book_append_sheet(wb, ws, 'Customer Segments');
            XLSX.writeFile(wb, `PinkBlue_Customer_Report_${startDate}_to_${endDate}.xlsx`);
        }

        function exportComparisonReport() {
            const periodAStart = document.getElementById('periodAStart').value;
            const periodAEnd = document.getElementById('periodAEnd').value;
            const periodBStart = document.getElementById('periodBStart').value;
            const periodBEnd = document.getElementById('periodBEnd').value;
            
            const comparison = [
                ['PinkBlue Analytics - Period Comparison'],
                [''],
                ['Metric', `Period A (${periodAStart} to ${periodAEnd})`, `Period B (${periodBStart} to ${periodBEnd})`, 'Change %'],
                ['Total Orders', 145, 132, '+9.8%'],
                ['Total Revenue', 485000, 442000, '+9.7%'],
                ['Success Rate', '91%', '88%', '+3.4%']
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(comparison);
            XLSX.utils.book_append_sheet(wb, ws, 'Comparison');
            XLSX.writeFile(wb, `PinkBlue_Comparison_${periodAStart}_to_${periodBEnd}.xlsx`);
        }
    </script>
</body>
</html>
