<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Access Denied</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Courier New', monospace; 
      background: #000; 
      color: #0f0; 
      overflow-x: hidden;
    }
    
    #auth-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .auth-text {
      position: relative;
      z-index: 10001;
      text-align: center;
      font-size: 18px;
      padding: 20px;
      line-height: 1.8;
      max-width: 600px;
    }
    
    .quote {
      font-size: 14px;
      opacity: 0.7;
      margin-top: 20px;
      font-style: italic;
    }
    
    #dashboard {
      display: none;
      background: #000;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(90deg, #000 0%, #001a00 100%);
      border-bottom: 2px solid #0f0;
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .title { 
      font-size: 22px; 
      font-weight: bold;
      text-shadow: 0 0 10px #0f0;
    }
    
    .tabs {
      display: flex;
      gap: 0;
      border: 2px solid #0f0;
      background: #000;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-right: 2px solid #0f0;
      transition: all 0.3s;
      font-size: 13px;
    }
    
    .tab:last-child { border-right: none; }
    
    .tab:hover {
      background: rgba(0, 255, 0, 0.1);
    }
    
    .tab.active {
      background: #0f0;
      color: #000;
      font-weight: bold;
    }
    
    .filters {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-top: 15px;
      padding: 15px;
      border: 2px solid #0f0;
      background: rgba(0, 255, 0, 0.05);
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .filter-group label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .filter-group input,
    .filter-group select {
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 8px 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    
    button {
      background: #000;
      color: #0f0;
      border: 2px solid #0f0;
      padding: 8px 16px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    button:hover {
      background: #0f0;
      color: #000;
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .content {
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .card {
      border: 2px solid #0f0;
      padding: 20px;
      background: rgba(0, 255, 0, 0.02);
      transition: all 0.3s;
    }
    
    .card:hover {
      background: rgba(0, 255, 0, 0.08);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
    }
    
    .card-title {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .card-value {
      font-size: 28px;
      font-weight: bold;
      text-shadow: 0 0 5px #0f0;
    }
    
    .card-sub {
      font-size: 12px;
      margin-top: 8px;
      opacity: 0.6;
    }
    
    .section {
      margin-bottom: 25px;
      border: 2px solid #0f0;
      background: rgba(0, 255, 0, 0.02);
    }
    
    .section-header {
      background: rgba(0, 255, 0, 0.1);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #0f0;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .section-content {
      padding: 20px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    .data-table th {
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #0f0;
      background: rgba(0, 255, 0, 0.1);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(0, 255, 0, 0.2);
    }
    
    .data-table tr:hover {
      background: rgba(0, 255, 0, 0.05);
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 16px;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .error {
      color: #f00;
      border-color: #f00;
      background: rgba(255, 0, 0, 0.1);
      padding: 20px;
      margin: 20px 0;
    }
    
    .ai-insight {
      white-space: pre-wrap;
      line-height: 1.8;
      padding: 20px;
      background: rgba(0, 255, 0, 0.05);
      border-left: 4px solid #0f0;
      font-size: 13px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid #0f0;
      font-size: 10px;
      margin-left: 10px;
      border-radius: 3px;
    }
    
    .badge.champions { background: rgba(0, 255, 0, 0.2); }
    .badge.loyal { background: rgba(0, 200, 255, 0.2); border-color: #0cf; color: #0cf; }
    .badge.at-risk { background: rgba(255, 100, 0, 0.2); border-color: #f60; color: #f60; }
    .badge.lost { background: rgba(255, 0, 0, 0.2); border-color: #f00; color: #f00; }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0, 255, 0, 0.2);
      margin-top: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #0f0;
      transition: width 0.5s;
      box-shadow: 0 0 10px #0f0;
    }
    
    .chart-container {
      height: 300px;
      border: 2px solid #0f0;
      padding: 20px;
      background: rgba(0, 255, 0, 0.02);
      position: relative;
    }
    
    .log-viewer {
      background: #000;
      border: 2px solid #0f0;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 11px;
      line-height: 1.6;
    }
    
    .log-entry {
      margin: 5px 0;
      opacity: 0.8;
    }
    
    .log-entry.info { color: #0f0; }
    .log-entry.error { color: #f00; }
    .log-entry.warn { color: #ff0; }
  </style>
</head>
<body>
  <div id="auth-screen">
    <canvas id="canvas"></canvas>
    <div class="auth-text">
      <div id="auth-quote"></div>
      <div class="quote" style="margin-top: 30px;">[ Type the passphrase to continue ]</div>
    </div>
  </div>
  
  <div id="dashboard">
    <div class="header">
      <div class="header-top">
        <div class="title">‚ö° PINKBLUE INTEL // ANALYTICS ENGINE</div>
        <div style="font-size: 12px; opacity: 0.7;" id="last-update"></div>
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="dashboard">üìä DASHBOARD</div>
        <div class="tab" data-tab="customers">üë• CUSTOMERS</div>
        <div class="tab" data-tab="products">üì¶ PRODUCTS</div>
        <div class="tab" data-tab="cancellations">‚ùå CANCELLATIONS</div>
        <div class="tab" data-tab="forecast">ü§ñ AI FORECAST</div>
        <div class="tab" data-tab="logs">üìù LOGS</div>
      </div>
      
      <div class="filters">
        <div class="filter-group">
          <label>FROM:</label>
          <input type="date" id="start-date">
        </div>
        <div class="filter-group">
          <label>TO:</label>
          <input type="date" id="end-date">
        </div>
        <div class="filter-group">
          <label>QUICK:</label>
          <select id="quick-filter">
            <option value="custom">Custom</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
          </select>
        </div>
        <button onclick="loadAllData()">üîÑ REFRESH</button>
      </div>
    </div>
    
    <div class="content">
      <div id="tab-dashboard" class="tab-content active"></div>
      <div id="tab-customers" class="tab-content"></div>
      <div id="tab-products" class="tab-content"></div>
      <div id="tab-cancellations" class="tab-content"></div>
      <div id="tab-forecast" class="tab-content"></div>
      <div id="tab-logs" class="tab-content">
        <div class="section">
          <div class="section-header">
            <div class="section-title">System Logs</div>
            <button onclick="document.getElementById('log-content').innerHTML = ''">Clear</button>
          </div>
          <div class="section-content">
            <div class="log-viewer" id="log-content"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PASSWORD = 'pinkblueanalytics109';
    const FUNNY_QUOTES = [
      "ü¶∑ 'A dentist's favorite time? Tooth-hurty!' - Loading PinkBlue Intel...",
      "üí° 'Why did the data go to therapy? It had too many issues!' - Initializing...",
      "üöÄ 'There are 10 types of people: those who understand binary and those who don't'",
      "ü§ì 'Debugging is like being a detective in a crime movie where you're also the murderer'",
      "üìä 'In God we trust. All others must bring data.' - W. Edwards Deming",
      "üíª 'It works on my machine' - Every developer ever",
      "üîê 'Access Denied... Just kidding, type the password!'",
      "‚ö° 'May the forecast be ever in your favor'",
      "üéØ 'Data doesn't lie, but it can be very misleading' - Loading Analytics...",
      "üß† 'AI is the new electricity' - Andrew Ng | Powering your insights..."
    ];
    
    let inputBuffer = '';
    let logBuffer = [];
    
    function addLog(level, message) {
      const timestamp = new Date().toLocaleTimeString();
      const entry = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
      console.log(entry);
      logBuffer.unshift({ level, message: entry, time: timestamp });
      if (logBuffer.length > 100) logBuffer.pop();
      updateLogViewer();
    }
    
    function updateLogViewer() {
      const logContent = document.getElementById('log-content');
      if (logContent) {
        logContent.innerHTML = logBuffer.map(log => 
          `<div class="log-entry ${log.level}">${log.message}</div>`
        ).join('');
      }
    }
    
    // Particle Animation
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const particles = [];
    for (let i = 0; i < 80; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.8,
        vy: (Math.random() - 0.5) * 0.8
      });
    }
    
    function animate() {
      ctx.fillStyle = 'rgba(0, 0, 0, 0.08)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.fillStyle = '#0f0';
      ctx.strokeStyle = '#0f0';
      
      particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
        if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
        ctx.fill();
      });
      
      particles.forEach((p1, i) => {
        particles.slice(i + 1).forEach(p2 => {
          const dx = p1.x - p2.x;
          const dy = p1.y - p2.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 120) {
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.globalAlpha = 1 - (dist / 120);
            ctx.stroke();
            ctx.globalAlpha = 1;
          }
        });
      });
      
      requestAnimationFrame(animate);
    }
    animate();
    
    // Auth
    document.getElementById('auth-quote').textContent = FUNNY_QUOTES[Math.floor(Math.random() * FUNNY_QUOTES.length)];
    
    document.addEventListener('keypress', (e) => {
      if (document.getElementById('auth-screen').style.display === 'none') return;
      inputBuffer += e.key;
      if (inputBuffer.length > PASSWORD.length) {
        inputBuffer = inputBuffer.slice(-PASSWORD.length);
      }
      if (inputBuffer === PASSWORD) {
        addLog('info', 'Authentication successful');
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        initDashboard();
      }
    });
    
    // Date Filters
    function initDashboard() {
      const today = new Date().toISOString().split('T')[0];
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      document.getElementById('end-date').value = today;
      document.getElementById('start-date').value = thirtyDaysAgo.toISOString().split('T')[0];
      
      document.getElementById('quick-filter').addEventListener('change', (e) => {
        const value = e.target.value;
        const end = new Date();
        const start = new Date();
        
        if (value === 'today') {
          start.setHours(0, 0, 0, 0);
        } else if (value === 'yesterday') {
          start.setDate(start.getDate() - 1);
          end.setDate(end.getDate() - 1);
        } else if (value !== 'custom') {
          start.setDate(start.getDate() - parseInt(value));
        }
        
        if (value !== 'custom') {
          document.getElementById('start-date').value = start.toISOString().split('T')[0];
          document.getElementById('end-date').value = end.toISOString().split('T')[0];
        }
      });
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
        });
      });
      
      loadAllData();
    }
    
    async function fetchAPI(type) {
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;
      addLog('info', `Fetching ${type} data from ${start} to ${end}`);
      
      try {
        const response = await fetch(`/.netlify/functions/analytics-engine?type=${type}&start_date=${start}&end_date=${end}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        addLog('info', `${type} data received successfully`);
        return data;
      } catch (error) {
        addLog('error', `Failed to fetch ${type}: ${error.message}`);
        throw error;
      }
    }
    
    async function loadAllData() {
      addLog('info', 'Loading all dashboard data...');
      document.getElementById('last-update').textContent = `Last Update: ${new Date().toLocaleString()}`;
      
      try {
        const [dashboard, customers, products, cancellations, forecast] = await Promise.all([
          fetchAPI('dashboard'),
          fetchAPI('customers'),
          fetchAPI('products'),
          fetchAPI('cancellations'),
          fetchAPI('forecast')
        ]);
        
        renderDashboard(dashboard);
        renderCustomers(customers);
        renderProducts(products);
        renderCancellations(cancellations);
        renderForecast(forecast);
        
        addLog('info', 'All data loaded successfully ‚úì');
      } catch (error) {
        addLog('error', `Dashboard load failed: ${error.message}`);
        document.getElementById('tab-dashboard').innerHTML = `<div class="error">‚ùå ERROR: ${error.message}<br><br>Check console and Netlify function logs for details.</div>`;
      }
    }
    
    function renderDashboard(data) {
      document.getElementById('tab-dashboard').innerHTML = `
        <div class="metrics">
          <div class="card">
            <div class="card-title">üí∞ Total Revenue</div>
            <div class="card-value">‚Çπ${data.revenue.toLocaleString()}</div>
            <div class="card-sub">Avg Daily: ‚Çπ${data.daily_stats.mean_daily_revenue.toLocaleString()}</div>
          </div>
          <div class="card">
            <div class="card-title">üì¶ Total Orders</div>
            <div class="card-value">${data.orders}</div>
            <div class="card-sub">Complete: ${data.complete_orders} | Pending: ${data.pending_orders}</div>
          </div>
          <div class="card">
            <div class="card-title">üí≥ Avg Order Value</div>
            <div class="card-value">‚Çπ${data.avg_order_value.toLocaleString()}</div>
            <div class="card-sub">œÉ = ‚Çπ${data.daily_stats.std_deviation.toLocaleString()}</div>
          </div>
          <div class="card">
            <div class="card-title">üíµ COD Orders</div>
            <div class="card-value">${data.cod_orders}</div>
            <div class="card-sub">${((data.cod_orders/data.orders)*100).toFixed(1)}% of total</div>
          </div>
          <div class="card">
            <div class="card-title">üíé Online Orders</div>
            <div class="card-value">${data.online_orders}</div>
            <div class="card-sub">${((data.online_orders/data.orders)*100).toFixed(1)}% of total</div>
          </div>
          <div class="card">
            <div class="card-title">‚ùå Cancellation Rate</div>
            <div class="card-value">${data.cancellation_rate}%</div>
            <div class="card-sub">${data.cancelled_orders} cancelled</div>
            <div class="progress-bar"><div class="progress-fill" style="width: ${data.cancellation_rate}%"></div></div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">üìà Statistical Analysis</div>
          </div>
          <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
              <div>
                <strong>Mean Daily Revenue:</strong><br>
                ‚Çπ${data.daily_stats.mean_daily_revenue.toLocaleString()}
              </div>
              <div>
                <strong>Standard Deviation (œÉ):</strong><br>
                ‚Çπ${data.daily_stats.std_deviation.toLocaleString()}
              </div>
              <div>
                <strong>Variance (œÉ¬≤):</strong><br>
                ‚Çπ${data.daily_stats.variance.toLocaleString()}
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderCustomers(data) {
      document.getElementById('tab-customers').innerHTML = `
        <div class="section">
          <div class="section-header">
            <div class="section-title">üë• Customer Segmentation (RFM Analysis)</div>
            <button onclick="exportData('customers')">‚Üì Export CSV</button>
          </div>
          <div class="section-content">
            <div class="metrics">
              <div class="card">
                <div class="card-title">Total Customers</div>
                <div class="card-value">${data.total}</div>
              </div>
              <div class="card">
                <div class="card-title">üèÜ Champions</div>
                <div class="card-value">${data.segments.champions}</div>
                <div class="card-sub">High RFM Score</div>
              </div>
              <div class="card">
                <div class="card-title">üíé Loyal</div>
                <div class="card-value">${data.segments.loyal}</div>
                <div class="card-sub">Regular Buyers</div>
              </div>
              <div class="card">
                <div class="card-title">üåü Promising</div>
                <div class="card-value">${data.segments.promising}</div>
                <div class="card-sub">Recent Activity</div>
              </div>
              <div class="card">
                <div class="card-title">üÜï New</div>
                <div class="card-value">${data.segments.new}</div>
                <div class="card-sub">First Purchase</div>
              </div>
              <div class="card">
                <div class="card-title">‚ö†Ô∏è At Risk</div>
                <div class="card-value">${data.segments.at_risk}</div>
                <div class="card-sub">90-180 Days</div>
              </div>
              <div class="card">
                <div class="card-title">üò¢ Lost</div>
                <div class="card-value">${data.segments.lost}</div>
                <div class="card-sub">>180 Days</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">üí∞ Top 20 Buyers</div>
          </div>
          <div class="section-content">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Customer</th>
                  <th>Segment</th>
                  <th>Total Spent</th>
                  <th>Orders</th>
                  <th>AOV</th>
                  <th>Last Order</th>
                  <th>Recency</th>
                  <th>RFM Score</th>
                </tr>
              </thead>
              <tbody>
                ${data.top_buyers.slice(0, 20).map(c => `
                  <tr>
                    <td>${c.email}</td>
                    <td><span class="badge ${c.segment.toLowerCase().replace(' ', '-')}">${c.segment}</span></td>
                    <td>‚Çπ${c.monetary.toLocaleString()}</td>
                    <td>${c.orders}</td>
                    <td>‚Çπ${c.avg_order_value.toLocaleString()}</td>
                    <td>${new Date(c.lastOrder).toLocaleDateString()}</td>
                    <td>${c.recency}d</td>
                    <td>${c.r_score}-${c.f_score}-${c.m_score}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderProducts(data) {
      document.getElementById('tab-products').innerHTML = `
        <div class="section">
          <div class="section-header">
            <div class="section-title">üèÜ Top 20 Sellers</div>
            <button onclick="exportData('products')">‚Üì Export CSV</button>
          </div>
          <div class="section-content">
            <table class="data-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Product Name</th>
                  <th>Revenue</th>
                  <th>Qty Sold</th>
                  <th>Orders</th>
                  <th>Avg Price</th>
                  <th>Cancel Rate</th>
                </tr>
              </thead>
              <tbody>
                ${data.top_sellers.slice(0, 20).map(p => `
                  <tr>
                    <td><code>${p.sku}</code></td>
                    <td>${p.name}</td>
                    <td><strong>‚Çπ${p.revenue.toLocaleString()}</strong></td>
                    <td>${p.qty}</td>
                    <td>${p.orders}</td>
                    <td>‚Çπ${p.avg_price}</td>
                    <td>${p.cancellation_rate}%</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        ${data.high_cancellation_risk.length > 0 ? `
        <div class="section">
          <div class="section-header">
            <div class="section-title">‚ö†Ô∏è High Cancellation Risk Products</div>
          </div>
          <div class="section-content">
            <table class="data-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Product Name</th>
                  <th>Cancellation Rate</th>
                  <th>Cancelled Qty</th>
                  <th>Lost Revenue</th>
                </tr>
              </thead>
              <tbody>
                ${data.high_cancellation_risk.slice(0, 15).map(p => `
                  <tr>
                    <td><code>${p.sku}</code></td>
                    <td>${p.name}</td>
                    <td><strong style="color: #f00;">${p.cancellation_rate}%</strong></td>
                    <td>${p.cancelled_qty}</td>
                    <td>‚Çπ${Math.round(p.cancelled_revenue).toLocaleString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        ` : ''}
      `;
    }
    
    function renderCancellations(data) {
      document.getElementById('tab-cancellations').innerHTML = `
        <div class="metrics">
          <div class="card">
            <div class="card-title">Total Cancelled</div>
            <div class="card-value">${data.total_cancelled}</div>
          </div>
          <div class="card">
            <div class="card-title">Cancellation Rate</div>
            <div class="card-value">${data.cancellation_rate}%</div>
            <div class="progress-bar"><div class="progress-fill" style="width: ${data.cancellation_rate}%"></div></div>
          </div>
          <div class="card">
            <div class="card-title">üí∏ Lost Revenue</div>
            <div class="card-value">‚Çπ${data.lost_revenue.toLocaleString()}</div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">‚ùå Recent Cancellations</div>
            <button onclick="exportData('cancellations')">‚Üì Export CSV</button>
          </div>
          <div class="section-content">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Date</th>
                  <th>Customer</th>
                  <th>Amount</th>
                  <th>Payment Method</th>
                </tr>
              </thead>
              <tbody>
                ${data.cancelled_orders.slice(0, 30).map(o => `
                  <tr>
                    <td><code>#${o.order_id}</code></td>
                    <td>${new Date(o.date).toLocaleString()}</td>
                    <td>${o.customer_email}</td>
                    <td>‚Çπ${o.amount.toLocaleString()}</td>
                    <td>${o.payment_method}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderForecast(data) {
      document.getElementById('tab-forecast').innerHTML = `
        <div class="metrics">
          <div class="card">
            <div class="card-title">ü§ñ Model</div>
            <div class="card-value" style="font-size: 16px;">${data.model}</div>
          </div>
          <div class="card">
            <div class="card-title">üìä Confidence (R¬≤)</div>
            <div class="card-value">${data.confidence}</div>
            <div class="card-sub">R¬≤ = ${data.statistics.r_squared}</div>
          </div>
          <div class="card">
            <div class="card-title">üîÆ Tomorrow's Prediction</div>
            <div class="card-value">‚Çπ${data.next_day_prediction.toLocaleString()}</div>
            <div class="card-sub">¬±‚Çπ${(data.confidence_interval.upper - data.next_day_prediction).toLocaleString()}</div>
          </div>
          <div class="card">
            <div class="card-title">üìà Trend Slope</div>
            <div class="card-value">${data.statistics.slope > 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'} ${Math.abs(data.statistics.slope).toFixed(2)}</div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">üß† AI Insights (Gemini 1.5 Flash)</div>
          </div>
          <div class="section-content">
            <div class="ai-insight">${data.ai_insight}</div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">üìä Statistical Summary</div>
          </div>
          <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; font-size: 14px;">
              <div>
                <strong>Mean Revenue:</strong><br>
                ‚Çπ${data.statistics.mean.toLocaleString()}
              </div>
              <div>
                <strong>Std Deviation (œÉ):</strong><br>
                ‚Çπ${data.statistics.std_dev.toLocaleString()}
              </div>
              <div>
                <strong>Variance (œÉ¬≤):</strong><br>
                ‚Çπ${data.statistics.variance.toLocaleString()}
              </div>
              <div>
                <strong>Regression Slope:</strong><br>
                ${data.statistics.slope}
              </div>
              <div>
                <strong>R-Squared:</strong><br>
                ${data.statistics.r_squared}
              </div>
              <div>
                <strong>Data Points:</strong><br>
                ${data.data_points} days
              </div>
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">üìÖ Daily Revenue Trend</div>
          </div>
          <div class="section-content">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Revenue</th>
                  <th>Orders</th>
                </tr>
              </thead>
              <tbody>
                ${data.daily_data.slice(-14).reverse().map(d => `
                  <tr>
                    <td>${d.date}</td>
                    <td>‚Çπ${d.revenue.toLocaleString()}</td>
                    <td>${d.orders}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function exportData(type) {
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;
      addLog('info', `Exporting ${type} data...`);
      window.location.href = `/.netlify/functions/analytics-engine?type=export&export=${type}&start_date=${start}&end_date=${end}`;
    }
  </script>
</body>
</html>
